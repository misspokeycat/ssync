<!doctype html>
<html>
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  <link rel="stylesheet" type="text/css" href="default.css">
  <body>
      <div id="player"></div>
      </br>
      <form>
        Enter a vidid: <input id="vidid" type="text">
      </form>
      <button id="timesync">Sync To Me</button>
      <p>
      <div id="playlist">
        <div id="itemTEST" class="plitem">  <!--this is going to be the template to be generated by code -->
          <img src="https://i.ytimg.com/vi/7lCDEYXw3mM/default.jpg">
          <div id="qtitle">Sample Text</div>
          <div id="qduration">00:00:00</div>
          <button id="btnQueue">Queue</button>
          <button id="btnPlay">Play</button>
        </div>
      </div>
      <script type="text/javascript">
          var currentvideo = 'M7lc1UVf-VE';
          var playerReady = false;
          var tag = document.createElement('script');
          tag.src = "https://www.youtube.com/iframe_api";
          var firstScriptTag = document.getElementsByTagName('script')[0];
          firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
          var player;
          function onYouTubeIframeAPIReady(){
            player = new YT.Player('player', {
            height: '390',
            width: '640',
            videoId: currentvideo,
            events: {
              'onReady' : onPlayerReady,
              'onStateChange' : onPlayerStateChange
            }
          });
        }
        function onPlayerReady(event){
          event.target.playVideo();
          playerReady = true;
        }
        var done = false;
        function onPlayerStateChange(event){
          //TODO: Add time synchronization
        }
      </script>
      <script type="text/javascript">
        var socket = io();
        //This sends the vidid in the vidid field to the server
        $('form').submit(function(e){
          e.preventDefault();
          socket.emit('video id', $('#vidid').val());
        });
        $('#timesync').click(function(){
          socket.emit('video time', player.getCurrentTime());
        });
        socket.on('video time', function(time){
          if (playerReady){
            //Sync accuracy constant.  Should be settable by user option, but that's TODO.
            var SYNC_ACCURACY = 1;
            if (Math.abs(player.getCurrentTime() - time) > SYNC_ACCURACY){
              console.log('seeking to ' + time);
              player.seekTo(time);
            }
          }
        });
        //This handles reciept of video ids.
        socket.on('video id', function(vid){
          //Sets youtube player to selected video
          currentvideo = vid;
          if (playerReady){
            player.loadVideoById(currentvideo);
          }
        });
      </script>
  </body>
</html>